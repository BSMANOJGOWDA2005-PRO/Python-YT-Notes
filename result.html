<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Result Photo Analyzer</title>
  <style>
    body {
        background: linear-gradient(135deg, #2980b9, #e6a122);
        background-size: 400% 400%;
        animation: gradientBG 15s ease infinite;
        color: #dfdbd9;
        font-family: Arial, sans-serif;
    }

    @keyframes gradientBG {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    h1, h2, h3, label {
      color: #f1e42d;
    }
    h1{
      text-align:center;
    }
    #preview{
      max-width:400px;
      max-height:250px;
      display:block;
      margin:10px auto;
      border:1px solid #1dc059;
      background:white;
    }
    #status{
      text-align:center;
      margin:10px;
      font-weight:bold;
    }
    .container{
      display:flex;
      flex-wrap:wrap;
      gap:20px;
      justify-content:center;
    }
    .card{
      background:rgb(8, 43, 51);
      padding:15px;
      border-radius:8px;
      box-shadow:0 0 5px rgba(0,0,0,0.1);
      min-width:300px;
    }
    table{
      border-collapse:collapse;
      width:100%;
      font-size:13px;
    }
    th, td{
      border:1px solid #181313;
      padding:4px 6px;
      text-align:center;
    }
    th{
      background:rgb(255, 0, 0);
    }

    input, select, button {
        background-color: rgba(219, 255, 40, 0.8);
        color: #333;
        border: none;
        border-radius: 5px;
        padding: 10px;
        margin: 5px 0;
        font-size: 1em;
    }

    button {
        background-color: #27ae60;
        color: #fff;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    button:hover {
        background-color: #2ecc71;
    }

    #marks-analysis-graph {
      background: rgb(8, 43, 51);
      margin: 20px auto;
      max-width: 800px;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgb(40, 84, 7);
    }

    #marksGraph {
      width: 100% !important;
      height: auto !important;
      border: 1px solid #333;
      margin-top: 20px;
    }

    #ocrTextBox {
      width: 100%;
      min-height: 100px;
      font-size: 12px;
      margin-top: 10px;
      padding: 5px;
      border-radius: 4px;
    }

    #detailedAnalysis ul {
      padding-left: 18px;
    }
    #detailedAnalysis li {
      margin-bottom: 4px;
    }

    #profileSection {
      display: none;
      margin: 20px auto;
      max-width: 600px;
      padding: 15px;
      background: #f4f4f4;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    #profileSection h2 {
      text-align: center;
    }

    #profileSection table {
      width: 100%;
      border-collapse: collapse;
      font-size: 1em;
    }

    #profileSection th {
      text-align: left;
      padding: 8px;
      background: #0a84ff;
      color: white;
    }

    #profileSection td {
      padding: 8px;
      border: 1px solid #ccc;
    }

    /* Profile Panel Styles */
    #profilePanel {
      width: 300px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      display: none;
      margin-top: 20px;
    }

    #profilePanel h2 {
      text-align: center;
      color: #333;
    }

    #profilePanel label {
      margin-top: 10px;
      display: block;
    }

    #profilePanel input, #profilePanel textarea {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    #profilePanel button {
      padding: 10px 20px;
      background: #2980b9;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
    }

    #profilePanel button:hover {
      background: #3498db;
    }
  </style>
</head>
<body>
<h1>Result Photo Analyzer</h1>

<div style="text-align:center;">
  <input type="file" id="imageInput" accept="image/*" />
</div>
<img id="preview" alt="Image preview" />

<div id="status">Upload result photo to startâ€¦</div>

<div class="container">
  <div class="card" style="flex:1 1 350px;">
    <h3>Marks Table</h3>
    <table id="marksTable">
      <thead>
        <tr>
          <th>Subject Code</th>
          <th>Subject Name</th>
          <th>Internal</th>
          <th>External</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <p id="summary"></p>
    <div id="detailedAnalysis"></div>

    <h4 style="margin-top:10px;">Raw OCR Text (for checking)</h4>
    <textarea id="ocrTextBox" readonly></textarea>
  </div>

  <div class="card" style="flex:1 1 350px;">
    <h3>Bar Graph â€“ Marks per Subject</h3>
    <canvas id="barChart"></canvas>
  </div>

  <div class="card" style="flex:1 1 350px;">
    <h3>Circle Graph â€“ Overall Marks</h3>
    <canvas id="circleChart"></canvas>
  </div>
</div>

<section id="marks-analysis-graph">
    <h2>Marks Analysis Graph</h2>
    <canvas id="marksGraph" width="800" height="400"></canvas>
</section>

<!-- Toggle Button -->
<button onclick="toggleProfile()" style="background-color: #2980b9; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; margin-top: 20px;">Profile</button>

<!-- User Profile Box -->
<div id="profilePanel" style="width: 300px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.2); display: none; margin-top: 20px;">
  <h2 style="text-align: center; color: #333;">User Profile</h2>

  <label>Name:</label>
  <input type="text" id="name" placeholder="Enter your name" style="width: 100%; padding: 10px; margin-top: 10px; border-radius: 6px; border: 1px solid #ccc;">

  <label>Email:</label>
  <input type="email" id="email" placeholder="Enter your email" style="width: 100%; padding: 10px; margin-top: 10px; border-radius: 6px; border: 1px solid #ccc;">

  <label>Phone:</label>
  <input type="text" id="phone" placeholder="Enter phone number" style="width: 100%; padding: 10px; margin-top: 10px; border-radius: 6px; border: 1px solid #ccc;">

  <label>About You:</label>
  <textarea id="about" rows="3" placeholder="Write something..." style="width: 100%; padding: 10px; margin-top: 10px; border-radius: 6px; border: 1px solid #ccc;"></textarea>

  <button onclick="saveProfile()" style="padding: 10px 20px; background: #2980b9; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 10px;">Save Profile</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const imageInput  = document.getElementById('imageInput');
  const preview     = document.getElementById('preview');
  const statusEl    = document.getElementById('status');
  const tbody       = document.querySelector('#marksTable tbody');
  const summaryEl   = document.getElementById('summary');
  const ocrTextBox  = document.getElementById('ocrTextBox');
  const detailedEl  = document.getElementById('detailedAnalysis');

  let barChart = null;
  let circleChart = null;

  const MAX_PER_SUBJECT = 100; // fixed max marks

  imageInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(ev){
      preview.src = ev.target.result;
    };
    reader.readAsDataURL(file);

    statusEl.textContent = "Reading text from image (OCR)â€¦ please wait";

    const imageURL = URL.createObjectURL(file);
    try{
      const result = await Tesseract.recognize(imageURL, 'eng', {
        logger: m => { /* optional progress logs */ }
      });
      const text = result.data.text;
      ocrTextBox.value = text;
      statusEl.textContent = "Text extracted. Parsing subjectsâ€¦";
      analyzeText(text);
    }catch(err){
      console.error(err);
      statusEl.textContent = "Error during OCR. See console.";
    }
  });

  function analyzeText(text){
    tbody.innerHTML = "";
    summaryEl.textContent = "";
    detailedEl.innerHTML = "";
    destroyCharts();
    clearMarksGraph();

    const lines = text
      .split(/\r?\n/)
      .map(l => l.trim())
      .filter(l => l.length > 0);

    const subjects = [];

    // ðŸ”¹ Try 3-line, then 2-line, then 1-line windows
    for (let i = 0; i < lines.length; i++) {
      let found = [];

      // try 3 lines together
      if (i + 2 < lines.length) {
        found = parseSubjectsFromLine(
          lines[i] + " " + lines[i+1] + " " + lines[i+2]
        );
        if (found.length > 0) {
          subjects.push(...found);
          i += 2;
          continue;
        }
      }

      // try 2 lines together
      if (i + 1 < lines.length) {
        found = parseSubjectsFromLine(
          lines[i] + " " + lines[i+1]
        );
        if (found.length > 0) {
          subjects.push(...found);
          i += 1;
          continue;
        }
      }

      // try single line
      found = parseSubjectsFromLine(lines[i]);
      if (found.length > 0) {
        subjects.push(...found);
      }
    }

    if(subjects.length === 0){
      statusEl.textContent = "Could not detect subject codes. OCR text might be unclear.";
      return;
    }

    // build table rows
    for (const s of subjects) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${s.code}</td>
        <td style="text-align:left">${s.name}</td>
        <td>
          <input type="number" class="mark-input internal"
                 min="0" max="${MAX_PER_SUBJECT}" value="" />
        </td>
        <td>
          <input type="number" class="mark-input external"
                 min="0" max="${MAX_PER_SUBJECT}" value="" />
        </td>
        <td class="total-mark">0</td>
      `;
      tbody.appendChild(tr);
    }

    // real-time updates
    const inputs = tbody.querySelectorAll('.mark-input');
    inputs.forEach(input => {
      input.addEventListener('input', updateMarksAnalysis);
    });

    updateMarksAnalysis();
    statusEl.textContent = "All subject codes detected. Enter internal & external marks to see analysis.";
  }

  /**
   * Parse ALL subjects from a single text chunk.
   * - Code: token that looksLikeSubjectCode
   * - Name: words until a number or next subject code
   */
  function parseSubjectsFromLine(line) {
    const parts = line.trim().split(/\s+/);
    const subjects = [];
    if (parts.length === 0) return subjects;

    for (let i = 0; i < parts.length; i++) {
      if (!looksLikeSubjectCode(parts[i])) continue;

      const code = parts[i];
      const nameParts = [];
      let j = i + 1;

      for (; j < parts.length; j++) {
        const token = parts[j];
        if (/^\d+$/.test(token)) break;
        if (looksLikeSubjectCode(token)) break;
        nameParts.push(token);
      }

      const name = nameParts.join(' ') || 'Subject';
      subjects.push({ code, name });

      i = j - 1;
    }

    return subjects;
  }

  // ðŸ”¸ Improved subject-code detection:
  // - must start with a LETTER (so 4KV23CS016 is NOT a subject)
  // - must contain letters + digits, length 5â€“12
  function looksLikeSubjectCode(token) {
    if (!/^[A-Z][A-Z0-9]*$/i.test(token)) return false;  // first char must be letter
    const hasLetter = /[A-Za-z]/.test(token);
    const hasDigit  = /\d/.test(token);
    if (!hasLetter || !hasDigit) return false;
    if (token.length < 5 || token.length > 12) return false;
    return true;
  }

  // live analysis and charts
  function updateMarksAnalysis() {
    const rows = tbody.querySelectorAll('tr');

    if (rows.length === 0) {
      summaryEl.textContent = "";
      detailedEl.innerHTML = "";
      destroyCharts();
      clearMarksGraph();
      return;
    }

    const subjects = [];

    rows.forEach(row => {
      const code = row.cells[0].textContent.trim();
      const name = row.cells[1].textContent.trim();

      const internalInput = row.querySelector('input.internal');
      const externalInput = row.querySelector('input.external');

      let internal = Number(internalInput.value);
      let external = Number(externalInput.value);

      if (isNaN(internal)) internal = 0;
      if (isNaN(external)) external = 0;

      const total = internal + external;
      const totalCell = row.querySelector('.total-mark');
      totalCell.textContent = total;

      subjects.push({ code, name, internal, external, total });
    });

    const labels = subjects.map(s => s.code);
    const totals = subjects.map(s => s.total);

    const totalInternal = subjects.reduce((a,s) => a + s.internal, 0);
    const totalExternal = subjects.reduce((a,s) => a + s.external, 0);
    const grandTotal    = totals.reduce((a,b) => a + b, 0);

    const maxMarks   = subjects.length * MAX_PER_SUBJECT;
    const percentage = maxMarks > 0 ? (grandTotal / maxMarks * 100).toFixed(2) : "0.00";

    const avgInternal = (totalInternal / subjects.length).toFixed(2);
    const avgExternal = (totalExternal / subjects.length).toFixed(2);
    const avgTotal    = (grandTotal    / subjects.length).toFixed(2);

    let bestSubject = subjects[0];
    let weakestSubject = subjects[0];
    for (let i = 1; i < subjects.length; i++) {
      if (subjects[i].total > bestSubject.total) bestSubject = subjects[i];
      if (subjects[i].total < weakestSubject.total) weakestSubject = subjects[i];
    }

    summaryEl.innerHTML = `
      <strong>Overall Marks Analysis (Live)</strong><br>
      Total Internal Marks: <strong>${totalInternal}</strong><br>
      Total External Marks: <strong>${totalExternal}</strong><br>
      Grand Total Marks: <strong>${grandTotal} / ${maxMarks}</strong><br>
      Overall Percentage: <strong>${percentage}%</strong><br>
      <br>
      Average Internal per Subject: <strong>${avgInternal}</strong><br>
      Average External per Subject: <strong>${avgExternal}</strong><br>
      Average Total per Subject: <strong>${avgTotal}</strong><br>
      <br>
      Best Subject: <strong>${bestSubject.code}</strong> - ${bestSubject.name}
      (Internal: ${bestSubject.internal}, External: ${bestSubject.external}, Total: ${bestSubject.total})<br>
      Weakest Subject: <strong>${weakestSubject.code}</strong> - ${weakestSubject.name}
      (Internal: ${weakestSubject.internal}, External: ${weakestSubject.external}, Total: ${weakestSubject.total})
    `;

    let detailHtml = `<h4>Subject-wise Analysis</h4><ul>`;
    subjects.forEach(s => {
      detailHtml += `
        <li>
          <strong>${s.code}</strong> - ${s.name} :
          Internal = <strong>${s.internal}</strong>,
          External = <strong>${s.external}</strong>,
          Total = <strong>${s.total}</strong>
        </li>
      `;
    });
    detailHtml += `</ul>`;
    detailedEl.innerHTML = detailHtml;

    updateCharts(labels, totals, grandTotal, maxMarks);
    updateMarksGraph(labels, totals, MAX_PER_SUBJECT);
  }

  function destroyCharts() {
    if (barChart)   { barChart.destroy(); barChart = null; }
    if (circleChart){ circleChart.destroy(); circleChart = null; }
  }

  function clearMarksGraph() {
    const canvas = document.getElementById('marksGraph');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }

  function updateCharts(labels, totals, grandTotal, maxMarks) {
    destroyCharts();

    const barCtx = document.getElementById('barChart').getContext('2d');
    barChart = new Chart(barCtx, {
      type:'bar',
      data:{
        labels:labels,
        datasets:[{
          label:'Total Marks',
          data:totals
        }]
      },
      options:{
        responsive:true,
        scales:{
          y:{
            beginAtZero:true,
            suggestedMax:MAX_PER_SUBJECT
          }
        }
      }
    });

    const circleCtx = document.getElementById('circleChart').getContext('2d');
    circleChart = new Chart(circleCtx, {
      type:'doughnut',
      data:{
        labels:['Obtained','Remaining'],
        datasets:[{
          data:[grandTotal, Math.max(maxMarks-grandTotal,0)]
        }]
      },
      options:{
        responsive:true,
        cutout:'60%'
      }
    });
  }

  function updateMarksGraph(labels, totals, maxPerSubj) {
    const canvas = document.getElementById('marksGraph');
    const ctx = canvas.getContext('2d');

    const graphWidth = canvas.width;
    const graphHeight = canvas.height;
    const padding = 50;

    const maxMarksPossible = maxPerSubj;
    const xStep = labels.length > 1
      ? (graphWidth - 2 * padding) / (labels.length - 1)
      : 0;
    const yScale = (graphHeight - 2 * padding) / maxMarksPossible;

    ctx.clearRect(0, 0, graphWidth, graphHeight);

    ctx.beginPath();
    ctx.moveTo(padding, padding);
    ctx.lineTo(padding, graphHeight - padding);
    ctx.lineTo(graphWidth - padding, graphHeight - padding);
    ctx.strokeStyle = '#ffffff';
    ctx.lineWidth = 2;
    ctx.stroke();

    if (labels.length === 0) return;

    ctx.beginPath();
    ctx.strokeStyle = '#ffffff';
    ctx.lineWidth = 2;
    totals.forEach((mark, index) => {
      const x = padding + index * xStep;
      const y = graphHeight - padding - mark * yScale;
      if (index === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    });
    ctx.stroke();

    totals.forEach((mark, index) => {
      const x = padding + index * xStep;
      const y = graphHeight - padding - mark * yScale;
      ctx.beginPath();
      ctx.arc(x, y, 4, 0, 2 * Math.PI);
      ctx.fillStyle = '#ffffff';
      ctx.fill();
    });

    ctx.fillStyle = '#ffffff';
    ctx.font = '12px Arial';
    labels.forEach((label, index) => {
      const x = padding + index * xStep;
      ctx.fillText(label, x - 20, graphHeight - padding + 20);
    });

    for (let i = 0; i <= maxMarksPossible; i += 10) {
      const y = graphHeight - padding - i * yScale;
      ctx.fillText(i, padding - 30, y + 5);
    }
  }

  function toggleProfile() {
    let panel = document.getElementById("profilePanel");

    if (panel.style.display === "none" || panel.style.display === "") {
      panel.style.display = "block";
    } else {
      panel.style.display = "none";
    }
  }

  function saveProfile() {
    alert("Profile Saved Successfully!");
  }
</script>

<section id="profileSection" style="display: none; margin: 20px auto; max-width: 600px; padding: 15px; background: #f4f4f4; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);">
  <h2 style="text-align: center;">Student Profile</h2>
  <table style="width: 100%; border-collapse: collapse; font-size: 1em;">
    <tr>
      <th style="text-align: left; padding: 8px; background: #0a84ff; color: white;">Field</th>
      <th style="text-align: left; padding: 8px; background: #0a84ff; color: white;">Details</th>
    </tr>
    <tr>
      <td style="padding: 8px; border: 1px solid #ccc;">Name</td>
      <td style="padding: 8px; border: 1px solid #ccc;">Aryan Sharma</td>
    </tr>
    <tr>
      <td style="padding: 8px; border: 1px solid #ccc;">College/University</td>
      <td style="padding: 8px; border: 1px solid #ccc;">Delhi College of Engineering</td>
    </tr>
    <tr>
      <td style="padding: 8px; border: 1px solid #ccc;">Location</td>
      <td style="padding: 8px; border: 1px solid #ccc;">New Delhi, India</td>
    </tr>
    <tr>
      <td style="padding: 8px; border: 1px solid #ccc;">Phone Number</td>
      <td style="padding: 8px; border: 1px solid #ccc;">+91 98765 43210</td>
    </tr>
    <tr>
      <td style="padding: 8px; border: 1px solid #ccc;">Email ID</td>
      <td style="padding: 8px; border: 1px solid #ccc;">aryan.sharma@email.com</td>
    </tr>
    <tr>
      <td style="padding: 8px; border: 1px solid #ccc;">Course/Major</td>
      <td style="padding: 8px; border: 1px solid #ccc;">B.Tech in Computer Science and Engineering</td>
    </tr>
  </table>
</section>
  <canvas id="marksChart" class="marks-chart"></canvas>
</div>
</body>
</html>